{% extends 'layouts/base.html' %}
{% load static %}
{% block content %}
<div class="json-tool-container">
    <!-- Header with quick actions -->
    <div class="tool-header">
        <div class="header-content">
            <h1>
                <i class="fas fa-code"></i> JSON Toolkit
                <!-- <span class="beta-badge">BETA</span> -->
            </h1>
            <p class="subtitle">Powerful JSON processing in your browser</p>
        </div>
        <div class="quick-actions">
            <button id="load-sample" class="btn-outline">
                <i class="fas fa-lightbulb"></i> Load Sample
            </button>
            <button id="clear-all" class="btn-outline-danger">
                <i class="fas fa-broom"></i> Clear All
            </button>
        </div>
    </div>

    <!-- Main workspace with resizable panels -->
    <div class="workspace">
        <!-- Input panel -->
        <div class="panel input-panel">
            <div class="panel-header">
                <h3><i class="fas fa-pencil-alt"></i> Input JSON</h3>
                <div class="panel-tools">
                    <div class="btn-group">
                        <button id="format-btn" class="btn-tool" title="Format JSON">
                            <i class="fas fa-align-left"></i>Format 
                        </button>
                        <button id="minify-btn" class="btn-tool" title="Minify JSON">
                            <i class="fas fa-compress-alt"></i>Minify
                        </button>
                        <button id="validate-btn" class="btn-tool" title="Validate JSON">
                            <i class="fas fa-check"></i>Validate
                        </button>
                        <button id="fix-btn" class="btn-tool" title="Auto Fix">
                            <i class="fas fa-magic"></i>Auto
                        </button>
                    </div>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="editor" title="Code Editor">
                            <i class="fas fa-code"></i>Editor
                        </button>
                        <button class="view-btn" data-view="tree" title="Tree View">
                            <i class="fas fa-project-diagram"></i>Tree
                        </button>
                        <button class="view-btn" data-view="form" title="Form Editor">
                            <i class="fas fa-edit"></i>Form
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel-body">
                <div id="editor-view" class="view-content active">
                    <div id="json-editor" class="code-editor"></div>
                </div>
                <div id="tree-view" class="view-content">
                    <div id="json-tree" class="tree-view"></div>
                </div>
                <div id="form-view" class="view-content">
                    <div id="json-form" class="form-view"></div>
                </div>
            </div>
            
            <div class="panel-footer">
                <div class="status-indicator" id="input-status">
                    <span class="status-icon"></span>
                    <span class="status-text">Ready</span>
                </div>
                <div class="file-actions">
                    <button class="btn-file" id="upload-json" title="Upload JSON file">
                        <i class="fas fa-upload"></i>
                    </button>
                    <input type="file" id="json-file-input" accept=".json,.txt" style="display: none;">
                    <button class="btn-file" id="paste-json" title="Paste from clipboard">
                        <i class="fas fa-paste"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Processing controls -->
        <div class="processing-controls">
            <div class="controls-container">
                <button id="process-btn" class="btn-primary">
                    <i class="fas fa-play"></i> Process
                </button>
                
                <div class="convert-options">
                    <label>Output Format:</label>
                    <select id="output-format" class="select-dropdown">
                        <option value="json">JSON</option>
                        <option value="yaml">YAML</option>
                        <option value="xml">XML</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
                
                <div class="format-options">
                    <label>Indentation:</label>
                    <select id="indent-size" class="select-dropdown">
                        <option value="2">2 spaces</option>
                        <option value="4" selected>4 spaces</option>
                        <option value="tab">Tab</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Output panel -->
        <div class="panel output-panel">
            <div class="panel-header">
                <h3><i class="fas fa-file-code"></i> Output</h3>
                <div class="panel-tools">
                    <div class="btn-group">
                        <button id="copy-output" class="btn-tool" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button id="download-output" class="btn-tool" title="Download file">
                            <i class="fas fa-download"></i>
                        </button>
                        <button id="share-output" class="btn-tool" title="Share">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel-body">
                <div id="output-editor" class="code-editor"></div>
            </div>
            
            <div class="panel-footer">
                <div class="status-indicator" id="output-status">
                    <span class="status-icon"></span>
                    <span class="status-text">Waiting for input</span>
                </div>
                <div class="output-info">
                    <span id="output-size">0 bytes</span>
                    <span id="output-lines">0 lines</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar for advanced features -->
    <div class="sidebar-toggle">
        <button id="toggle-sidebar">
            <i class="fas fa-cog"></i>
            <span>Advanced</span>
        </button>
    </div>
    
    <div class="sidebar" id="advanced-sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-sliders-h"></i> Advanced Tools</h3>
            <button class="close-sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- Schema validation -->
            <div class="sidebar-section">
                <h4><i class="fas fa-check-double"></i> Schema Validation</h4>
                <div class="schema-container">
                    <textarea id="schema-input" placeholder="Paste JSON Schema here..."></textarea>
                    <button id="validate-schema" class="btn-secondary">
                        <i class="fas fa-check-circle"></i> Validate
                    </button>
                </div>
            </div>
            
            <!-- URL import -->
            <div class="sidebar-section">
                <h4><i class="fas fa-link"></i> Import from URL</h4>
                <div class="url-import">
                    <input type="text" id="json-url" placeholder="Enter JSON URL...">
                    <button id="load-url" class="btn-secondary">
                        <i class="fas fa-cloud-download-alt"></i> Fetch
                    </button>
                </div>
            </div>
            
            <!-- Transformations -->
            <div class="sidebar-section">
                <h4><i class="fas fa-exchange-alt"></i> Transformations</h4>
                <div class="transform-actions">
                    <button id="flatten-json" class="btn-outline">
                        <i class="fas fa-layer-group"></i> Flatten
                    </button>
                    <button id="unflatten-json" class="btn-outline">
                        <i class="fas fa-object-group"></i> Unflatten
                    </button>
                    <button id="sort-keys" class="btn-outline">
                        <i class="fas fa-sort-alpha-down"></i> Sort Keys
                    </button>
                </div>
            </div>
            
            <!-- History -->
            <div class="sidebar-section">
                <h4><i class="fas fa-history"></i> History</h4>
                <div class="history-controls">
                    <button id="undo-btn" class="btn-outline" disabled>
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button id="redo-btn" class="btn-outline" disabled>
                        <i class="fas fa-redo"></i> Redo
                    </button>
                </div>
                <div class="history-list" id="history-items">
                    <!-- History items will be added here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sample JSON selector -->
<div class="modal" id="sample-modal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3>Load Sample JSON</h3>
            <button class="close-modal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="sample-categories">
                <div class="category">
                    <h4>Basic Structures</h4>
                    <div class="sample-options">
                        <button class="sample-btn" data-sample="simple-object">
                            <i class="fas fa-cube"></i> Simple Object
                        </button>
                        <button class="sample-btn" data-sample="array">
                            <i class="fas fa-layer-group"></i> Array
                        </button>
                        <button class="sample-btn" data-sample="nested">
                            <i class="fas fa-sitemap"></i> Nested
                        </button>
                    </div>
                </div>
                
                <div class="category">
                    <h4>Real-world Examples</h4>
                    <div class="sample-options">
                        <button class="sample-btn" data-sample="api-response">
                            <i class="fas fa-cloud"></i> API Response
                        </button>
                        <button class="sample-btn" data-sample="config">
                            <i class="fas fa-cog"></i> Config File
                        </button>
                        <button class="sample-btn" data-sample="geo">
                            <i class="fas fa-map-marked-alt"></i> GeoJSON
                        </button>
                    </div>
                </div>
                
                <div class="category">
                    <h4>Testing</h4>
                    <div class="sample-options">
                        <button class="sample-btn" data-sample="invalid">
                            <i class="fas fa-exclamation-triangle"></i> Invalid
                        </button>
                        <button class="sample-btn" data-sample="large">
                            <i class="fas fa-database"></i> Large Dataset
                        </button>
                        <button class="sample-btn" data-sample="unicode">
                            <i class="fas fa-language"></i> Unicode
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help tooltip system -->
<div class="tooltip" id="global-tooltip"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize editors
    const inputEditor = ace.edit("json-editor");
    inputEditor.setTheme("ace/theme/tomorrow");
    inputEditor.session.setMode("ace/mode/json");
    inputEditor.setOptions({
        fontSize: "13px",
        tabSize: 4,
        useSoftTabs: true,
        showPrintMargin: false,
        highlightActiveLine: true,
        highlightSelectedWord: true,
        showLineNumbers: true,
        showGutter: true,
        autoScrollEditorIntoView: true
    });
    
    // Add subtle guide lines
    inputEditor.renderer.setOption("showInvisibles", true);
    inputEditor.renderer.setOption("highlightGutterLine", true);
    
    const outputEditor = ace.edit("output-editor");
    outputEditor.setTheme("ace/theme/tomorrow");
    outputEditor.session.setMode("ace/mode/json");
    outputEditor.setOptions({
        fontSize: "13px",
        tabSize: 4,
        useSoftTabs: true,
        showPrintMargin: false,
        highlightActiveLine: false,
        readOnly: true,
        showLineNumbers: true,
        showGutter: true
    });

    // Initialize JSON tree viewer
    const treeContainer = document.getElementById('tree-view');
    const treeEditor = new JSONEditor(treeContainer, {
        mode: 'tree',
        modes: ['tree', 'view', 'form'],
        search: true,
        history: true,
        onChange: function() {
            try {
                const json = treeEditor.get();
                inputEditor.setValue(JSON.stringify(json, null, 4));
                updateStatus('success', 'Tree updated');
            } catch (err) {
                updateStatus('error', err.message);
            }
        }
    });

    // Initialize form editor
    const formContainer = document.getElementById('form-view');
    const formEditor = new JSONEditor(formContainer, {
        mode: 'form',
        modes: ['form', 'tree', 'view'],
        disable_array_add: false,
        disable_array_delete: false,
        disable_array_reorder: false,
        disable_collapse: false,
        disable_edit_json: true,
        disable_properties: false,
        onChange: function() {
            try {
                const json = formEditor.get();
                inputEditor.setValue(JSON.stringify(json, null, 4));
                updateStatus('success', 'Form updated');
            } catch (err) {
                updateStatus('error', err.message);
            }
        }
    });

    // View switching
    const viewButtons = document.querySelectorAll('.view-btn');
    const viewContents = document.querySelectorAll('.view-content');
    
    viewButtons.forEach(button => {
        button.addEventListener('click', () => {
            const view = button.dataset.view;
            
            // Update active button
            viewButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update active view
            viewContents.forEach(content => content.classList.remove('active'));
            document.getElementById(`${view}-view`).classList.add('active');
            
            // If switching to tree or form view, try to parse the JSON
            if (view === 'tree' || view === 'form') {
                try {
                    const json = JSON.parse(inputEditor.getValue());
                    if (view === 'tree') {
                        treeEditor.set(json);
                    } else {
                        formEditor.set(json);
                    }
                    updateStatus('success', 'JSON is valid');
                } catch (err) {
                    updateStatus('error', err.message);
                }
            }
        });
    });

    
    // Process button (main action)
    document.getElementById('process-btn').addEventListener('click', processJSON);
    
    function processJSON() {
        try {
            const input = inputEditor.getValue();
            const format = document.getElementById('output-format').value;
            const indent = document.getElementById('indent-size').value;
            
            // First validate JSON
            const json = JSON.parse(input);
            
            // Process based on output format
            let result;
            switch (format) {
                case 'json':
                    const indentSize = indent === 'tab' ? '\t' : parseInt(indent);
                    result = JSON.stringify(json, null, indentSize);
                    break;
                case 'yaml':
                    result = jsyaml.dump(json);
                    break;
                case 'xml':
                    const x2js = new X2JS();
                    result = x2js.json2xml_str(json);
                    break;
                case 'csv':
                    const parser = new json2csv.Parser();
                    result = parser.parse(json);
                    break;
                default:
                    throw new Error('Unsupported format');
            }
            
            // Set output
            outputEditor.setValue(result);
            outputEditor.session.setMode(getModeForFormat(format));
            
            // Update output info
            updateOutputInfo(result);
            updateStatus('success', `Converted to ${format.toUpperCase()} successfully`);
            
        } catch (err) {
            updateStatus('error', err.message);
            updateOutputInfo('');
        }
    }
    
    // Format button
    document.getElementById('format-btn').addEventListener('click', function() {
        try {
            const json = inputEditor.getValue();
            const indent = document.getElementById('indent-size').value;
            const indentSize = indent === 'tab' ? '\t' : parseInt(indent);
            
            const formatted = js_beautify(json, {
                indent_size: indentSize,
                indent_char: indent === 'tab' ? '\t' : ' ',
                indent_with_tabs: indent === 'tab',
                wrap_line_length: 100,
                brace_style: 'collapse,preserve-inline'
            });
            
            inputEditor.setValue(formatted);
            updateStatus('success', 'JSON formatted');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    // Minify button
    document.getElementById('minify-btn').addEventListener('click', function() {
        try {
            const json = inputEditor.getValue();
            const minified = JSON.stringify(JSON.parse(json));
            inputEditor.setValue(minified);
            updateStatus('success', 'JSON minified');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    // Validate button
    document.getElementById('validate-btn').addEventListener('click', function() {
        try {
            JSON.parse(inputEditor.getValue());
            updateStatus('success', 'Valid JSON');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    // Auto-fix button
    document.getElementById('fix-btn').addEventListener('click', function() {
        try {
            // Try to parse first
            JSON.parse(inputEditor.getValue());
            updateStatus('info', 'JSON is already valid');
        } catch (err) {
            let jsonString = inputEditor.getValue();
            
            // Common fixes
            jsonString = jsonString
                .replace(/'/g, '"') // Single to double quotes
                .replace(/,\s*([}\]])/g, '$1') // Trailing commas
                .replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3') // Unquoted keys
                .replace(/\\'/g, "'") // Escaped single quotes
                .replace(/\\"/g, '"') // Escaped double quotes
                .replace(/[\u0000-\u001F\u007F-\u009F]/g, ''); // Remove control chars
            
            try {
                JSON.parse(jsonString);
                inputEditor.setValue(jsonString);
                updateStatus('success', 'Fixed common JSON issues');
            } catch (fixErr) {
                updateStatus('error', 'Unable to auto-fix: ' + fixErr.message);
            }
        }
    });
    
    // Copy output
    document.getElementById('copy-output').addEventListener('click', function() {
        const output = outputEditor.getValue();
        if (!output) {
            updateStatus('warning', 'No output to copy');
            return;
        }
        
        navigator.clipboard.writeText(output).then(() => {
            showTooltip(this, 'Copied to clipboard!');
            updateStatus('success', 'Copied to clipboard');
        }).catch(err => {
            updateStatus('error', 'Failed to copy: ' + err.message);
        });
    });
    
    // Download output
    document.getElementById('download-output').addEventListener('click', function() {
        const output = outputEditor.getValue();
        if (!output) {
            updateStatus('warning', 'No output to download');
            return;
        }
        
        const format = document.getElementById('output-format').value;
        const filename = `json-tool-output.${format}`;
        const blob = new Blob([output], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        updateStatus('success', 'Download started');
    });
    
    // Share output
    document.getElementById('share-output').addEventListener('click', function() {
        const output = outputEditor.getValue();
        if (!output) {
            updateStatus('warning', 'No output to share');
            return;
        }
        
        if (navigator.share) {
            navigator.share({
                title: 'JSON Tool Output',
                text: 'Check out this JSON data:',
                url: 'data:text/plain;charset=utf-8,' + encodeURIComponent(output)
            }).catch(err => {
                updateStatus('error', 'Error sharing: ' + err.message);
            });
        } else {
            // Fallback
            navigator.clipboard.writeText(output).then(() => {
                showTooltip(this, 'Output copied to clipboard!');
                updateStatus('success', 'Copied to clipboard (share not supported)');
            });
        }
    });
    
    // File upload
    document.getElementById('upload-json').addEventListener('click', function() {
        document.getElementById('json-file-input').click();
    });
    
    document.getElementById('json-file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            inputEditor.setValue(e.target.result);
            updateStatus('success', `Loaded ${file.name}`);
            addHistoryItem(`Uploaded: ${file.name}`);
        };
        reader.onerror = function() {
            updateStatus('error', 'Error reading file');
        };
        reader.readAsText(file);
        
        // Reset input to allow re-uploading the same file
        e.target.value = '';
    });
    
    // Paste from clipboard
    document.getElementById('paste-json').addEventListener('click', function() {
        navigator.clipboard.readText().then(text => {
            inputEditor.setValue(text);
            updateStatus('success', 'Pasted from clipboard');
            addHistoryItem('Pasted from clipboard');
        }).catch(err => {
            updateStatus('error', 'Failed to read clipboard: ' + err.message);
        });
    });
    
    // URL import
    document.getElementById('load-url').addEventListener('click', function() {
        const url = document.getElementById('json-url').value.trim();
        if (!url) {
            updateStatus('warning', 'Please enter a URL');
            return;
        }
        
        if (!url.match(/^https?:\/\//i)) {
            updateStatus('error', 'Invalid URL - must start with http:// or https://');
            return;
        }
        
        updateStatus('info', 'Fetching JSON from URL...');
        
        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.text();
            })
            .then(text => {
                inputEditor.setValue(text);
                updateStatus('success', 'URL loaded successfully');
                addHistoryItem(`Loaded from: ${url}`);
            })
            .catch(err => {
                updateStatus('error', 'Failed to load URL: ' + err.message);
            });
    });
    
    // Schema validation
    document.getElementById('validate-schema').addEventListener('click', async function() {
        try {
            const json = JSON.parse(inputEditor.getValue());
            const schemaText = document.getElementById('schema-input').value.trim();
            
            if (!schemaText) {
                updateStatus('warning', 'Please enter a JSON Schema');
                return;
            }
            
            const schema = JSON.parse(schemaText);
            const ajv = new Ajv({ allErrors: true, verbose: true });
            const validate = ajv.compile(schema);
            const valid = validate(json);
            
            if (valid) {
                updateStatus('success', 'JSON validates against the schema');
            } else {
                let errors = 'Schema validation failed:\n';
                validate.errors.forEach((err, index) => {
                    errors += `${index + 1}. ${err.instancePath || 'root'}: ${err.message}\n`;
                });
                updateStatus('error', errors);
            }
        } catch (err) {
            updateStatus('error', 'Schema validation error: ' + err.message);
        }
    });
    
    // Sample JSON modal
    const sampleModal = document.getElementById('sample-modal');
    const openSampleModal = document.getElementById('load-sample');
    const closeSampleModal = document.querySelector('.close-modal');
    
    openSampleModal.addEventListener('click', () => {
        sampleModal.style.display = 'flex';
    });
    
    closeSampleModal.addEventListener('click', () => {
        sampleModal.style.display = 'none';
    });
    
    window.addEventListener('click', (e) => {
        if (e.target === sampleModal) {
            sampleModal.style.display = 'none';
        }
    });
    
    // Sample buttons
    document.querySelectorAll('.sample-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const sampleType = this.dataset.sample;
            let sampleJson;
            
            switch (sampleType) {
                case 'simple-object':
                    sampleJson = {
                        "name": "John Doe",
                        "age": 35,
                        "isActive": true,
                        "address": {
                            "street": "123 Main St",
                            "city": "Anytown"
                        }
                    };
                    break;
                case 'array':
                    sampleJson = [
                        {"id": 1, "name": "Alice", "role": "admin"},
                        {"id": 2, "name": "Bob", "role": "user"},
                        {"id": 3, "name": "Charlie", "role": "user"}
                    ];
                    break;
                case 'nested':
                    sampleJson = {
                        "users": [
                            {
                                "id": 1,
                                "profile": {
                                    "name": "Alice",
                                    "preferences": {
                                        "theme": "dark",
                                        "notifications": true
                                    }
                                }
                            }
                        ],
                        "metadata": {
                            "created": "2023-01-01",
                            "version": "1.0.0"
                        }
                    };
                    break;
                case 'api-response':
                    sampleJson = {
                        "status": "success",
                        "data": {
                            "products": [
                                {
                                    "id": "p1",
                                    "name": "Laptop",
                                    "price": 999.99,
                                    "inStock": true
                                },
                                {
                                    "id": "p2",
                                    "name": "Phone",
                                    "price": 699.99,
                                    "inStock": false
                                }
                            ],
                            "total": 2
                        }
                    };
                    break;
                case 'config':
                    sampleJson = {
                        "$schema": "http://json-schema.org/draft-07/schema#",
                        "appName": "MyApp",
                        "version": "2.3.1",
                        "settings": {
                            "debug": false,
                            "maxConnections": 10,
                            "timeout": 30
                        },
                        "plugins": ["analytics", "logger", "notifications"]
                    };
                    break;
                case 'geo':
                    sampleJson = {
                        "type": "FeatureCollection",
                        "features": [
                            {
                                "type": "Feature",
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [102.0, 0.5]
                                },
                                "properties": {
                                    "name": "Sample Point"
                                }
                            }
                        ]
                    };
                    break;
                case 'invalid':
                    sampleJson = `{
                        name: "John",
                        age: 30,
                        isActive: true,
                        address: {
                            street: "123 Main",
                            city: "Anytown",
                        },
                        tags: ["user", "test",]
                    }`;
                    inputEditor.setValue(sampleJson);
                    sampleModal.style.display = 'none';
                    updateStatus('warning', 'Loaded invalid JSON sample');
                    return;
                case 'large':
                    // Generate a large sample
                    sampleJson = {
                        "metadata": { "generated": new Date().toISOString() },
                        "data": Array(100).fill().map((_, i) => ({
                            "id": `item-${i}`,
                            "value": Math.random(),
                            "nested": Array(5).fill().map((_, j) => ({
                                "id": `nested-${i}-${j}`,
                                "flag": j % 2 === 0
                            }))
                        }))
                    };
                    break;
                case 'unicode':
                    sampleJson = {
                        "description": "Sample with Unicode characters",
                        "languages": {
                            "japanese": "æ—¥æœ¬èªž",
                            "chinese": "ä¸­æ–‡",
                            "russian": "Ð ÑƒÑÑÐºÐ¸Ð¹",
                            "emoji": "ðŸ˜€ðŸš€ðŸŒˆ"
                        }
                    };
                    break;
                default:
                    sampleJson = {};
            }
            
            inputEditor.setValue(JSON.stringify(sampleJson, null, 4));
            sampleModal.style.display = 'none';
            updateStatus('success', `Loaded ${sampleType.replace('-', ' ')} sample`);
            addHistoryItem(`Loaded sample: ${sampleType.replace('-', ' ')}`);
        });
    });
    
    // Clear all button
    document.getElementById('clear-all').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all content?')) {
            inputEditor.setValue('');
            outputEditor.setValue('');
            updateStatus('info', 'Cleared all content');
            updateOutputInfo('');
            addHistoryItem('Cleared all content');
        }
    });
    
    // Sidebar toggle
    const sidebar = document.getElementById('advanced-sidebar');
    const toggleSidebar = document.getElementById('toggle-sidebar');
    const closeSidebar = document.querySelector('.close-sidebar');
    
    toggleSidebar.addEventListener('click', () => {
        sidebar.classList.toggle('active');
    });
    
    closeSidebar.addEventListener('click', () => {
        sidebar.classList.remove('active');
    });
    
    // History functionality
    const history = [];
    let historyIndex = -1;
    const historyList = document.getElementById('history-items');
    
    inputEditor.on('change', function() {
        const currentValue = inputEditor.getValue();
        
        // Don't record if the change is from undo/redo
        if (history[historyIndex] === currentValue) return;
        
        // Remove any forward history
        if (historyIndex < history.length - 1) {
            history.splice(historyIndex + 1);
        }
        
        history.push(currentValue);
        historyIndex = history.length - 1;
        updateHistoryButtons();
    });
    
    document.getElementById('undo-btn').addEventListener('click', function() {
        if (historyIndex > 0) {
            historyIndex--;
            inputEditor.setValue(history[historyIndex]);
            inputEditor.clearSelection();
            updateHistoryButtons();
            updateStatus('info', 'Undo');
        }
    });
    
    document.getElementById('redo-btn').addEventListener('click', function() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            inputEditor.setValue(history[historyIndex]);
            inputEditor.clearSelection();
            updateHistoryButtons();
            updateStatus('info', 'Redo');
        }
    });
    
    function updateHistoryButtons() {
        document.getElementById('undo-btn').disabled = historyIndex <= 0;
        document.getElementById('redo-btn').disabled = historyIndex >= history.length - 1;
    }
    
    function addHistoryItem(action) {
        const now = new Date();
        const time = now.toLocaleTimeString();
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `<span class="history-time">${time}</span> ${action}`;
        historyList.insertBefore(item, historyList.firstChild);
        
        // Limit history items
        if (historyList.children.length > 10) {
            historyList.removeChild(historyList.lastChild);
        }
    }
    
    // Transformation buttons
    document.getElementById('flatten-json').addEventListener('click', function() {
        try {
            const json = JSON.parse(inputEditor.getValue());
            const flattened = flattenObject(json);
            inputEditor.setValue(JSON.stringify(flattened, null, 4));
            updateStatus('success', 'JSON flattened');
            addHistoryItem('Applied: Flatten JSON');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    document.getElementById('unflatten-json').addEventListener('click', function() {
        try {
            const json = JSON.parse(inputEditor.getValue());
            const unflattened = unflattenObject(json);
            inputEditor.setValue(JSON.stringify(unflattened, null, 4));
            updateStatus('success', 'JSON unflattened');
            addHistoryItem('Applied: Unflatten JSON');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    document.getElementById('sort-keys').addEventListener('click', function() {
        try {
            const json = JSON.parse(inputEditor.getValue());
            const sorted = sortObjectKeys(json);
            inputEditor.setValue(JSON.stringify(sorted, null, 4));
            updateStatus('success', 'Object keys sorted');
            addHistoryItem('Applied: Sort keys');
        } catch (err) {
            updateStatus('error', err.message);
        }
    });
    
    // Helper functions
    function updateStatus(type, message) {
        const inputStatus = document.getElementById('input-status');
        const icon = inputStatus.querySelector('.status-icon');
        const text = inputStatus.querySelector('.status-text');
        
        inputStatus.className = `status-indicator status-${type}`;
        icon.className = `status-icon fas ${
            type === 'success' ? 'fa-check-circle' :
            type === 'error' ? 'fa-times-circle' :
            type === 'warning' ? 'fa-exclamation-triangle' :
            'fa-info-circle'
        }`;
        text.textContent = message;
    }
    
    function updateOutputInfo(content) {
        const size = new Blob([content]).size;
        const lines = content ? content.split('\n').length : 0;
        
        document.getElementById('output-size').textContent = formatBytes(size);
        document.getElementById('output-lines').textContent = `${lines} line${lines !== 1 ? 's' : ''}`;
    }
    
    function formatBytes(bytes) {
        if (bytes === 0) return '0 bytes';
        const k = 1024;
        const sizes = ['bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i]);
    }
    
    function getModeForFormat(format) {
        switch (format) {
            case 'json': return 'ace/mode/json';
            case 'xml': return 'ace/mode/xml';
            case 'yaml': return 'ace/mode/yaml';
            case 'csv': return 'ace/mode/text';
            default: return 'ace/mode/text';
        }
    }
    
    function showTooltip(element, message) {
        const tooltip = document.getElementById('global-tooltip');
        tooltip.textContent = message;
        
        const rect = element.getBoundingClientRect();
        tooltip.style.left = `${rect.left + rect.width/2}px`;
        tooltip.style.top = `${rect.top - 40}px`;
        
        tooltip.classList.add('show');
        setTimeout(() => tooltip.classList.remove('show'), 2000);
    }
    
    function flattenObject(obj, prefix = '') {
        return Object.keys(obj).reduce((acc, k) => {
            const pre = prefix.length ? prefix + '.' : '';
            if (typeof obj[k] === 'object' && obj[k] !== null && !Array.isArray(obj[k])) {
                Object.assign(acc, flattenObject(obj[k], pre + k));
            } else {
                acc[pre + k] = obj[k];
            }
            return acc;
        }, {});
    }
    
    function unflattenObject(obj) {
        return Object.keys(obj).reduce((acc, k) => {
            const keys = k.split('.');
            keys.reduce((a, e, i) => {
                if (i === keys.length - 1) {
                    a[e] = obj[k];
                } else if (!a[e]) {
                    a[e] = {};
                }
                return a[e];
            }, acc);
            return acc;
        }, {});
    }
    
    function sortObjectKeys(obj) {
        if (Array.isArray(obj)) {
            return obj.map(item => sortObjectKeys(item));
        } else if (typeof obj === 'object' && obj !== null) {
            return Object.keys(obj)
                .sort()
                .reduce((sorted, key) => {
                    sorted[key] = sortObjectKeys(obj[key]);
                    return sorted;
                }, {});
        }
        return obj;
    }
    
    // Initialize with empty object
    inputEditor.setValue('{\n    \n}');
    inputEditor.focus();
});
</script>

<style>
/* Base styles */
.json-tool-container {
    font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    color: #333;
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 40px);
    position: relative;
}

.tool-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e1e4e8;
}

.tool-header h1 {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.tool-header h1 i {
    color: #3498db;
}

.beta-badge {
    background: #f39c12;
    color: white;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 10px;
    font-weight: 500;
}

.subtitle {
    margin: 5px 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

.quick-actions {
    display: flex;
    gap: 10px;
}

/* Workspace layout */
.workspace {
    display: flex;
    flex: 1;
    gap: 20px;
    min-height: 0;
}

.panel {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex: 1;
}

.input-panel {
    flex: 1.2;
}

.output-panel {
    flex: 1;
}

.panel-header {
    padding: 12px 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
}

.panel-tools {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-group {
    display: flex;
    gap: 5px;
}

.btn-tool {
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px 8px;
    color: #555;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
}

.btn-tool:hover {
    background: #f0f0f0;
    border-color: #ccc;
}

.btn-tool i {
    font-size: 14px;
}

.view-toggle {
    display: flex;
    gap: 5px;
    margin-left: 10px;
}

.view-btn {
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 5px 8px;
    color: #777;
    cursor: pointer;
    transition: all 0.2s;
}

.view-btn.active {
    background: #e3f2fd;
    border-color: #bbdefb;
    color: #1976d2;
}

.view-btn:hover {
    background: #f5f5f5;
}

.panel-body {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.view-content {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: none;
}

.view-content.active {
    display: block;
}

.code-editor {
    width: 100%;
    height: 100%;
}

.tree-view, .form-view {
    width: 100%;
    height: 100%;
    padding: 10px;
    overflow: auto;
}

.panel-footer {
    padding: 8px 15px;
    background: #f8f9fa;
    border-top: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
}

.status-icon {
    font-size: 14px;
}

.status-success .status-icon {
    color: #27ae60;
}

.status-error .status-icon {
    color: #e74c3c;
}

.status-warning .status-icon {
    color: #f39c12;
}

.status-info .status-icon {
    color: #3498db;
}

.status-text {
    color: #555;
}

.file-actions {
    display: flex;
    gap: 8px;
}

.btn-file {
    background: none;
    border: none;
    color: #555;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
}

.btn-file:hover {
    color: #2980b9;
}

.output-info {
    display: flex;
    gap: 15px;
    color: #777;
}

/* Processing controls */
.processing-controls {
    width: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 40px;
}

.controls-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

#process-btn {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#process-btn:hover {
    background: #2980b9;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.convert-options, .format-options {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    width: 100%;
}

.convert-options label, .format-options label {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 500;
}

.select-dropdown {
    width: 100%;
    padding: 5px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    background: white;
}

/* Sidebar */
.sidebar-toggle {
    position: absolute;
    right: 20px;
    bottom: 20px;
}

#toggle-sidebar {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.sidebar {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100vh;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.sidebar.active {
    right: 0;
}

.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.sidebar-header h3 {
    margin: 0;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.close-sidebar {
    background: none;
    border: none;
    font-size: 18px;
    color: #7f8c8d;
    cursor: pointer;
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.sidebar-section {
    margin-bottom: 20px;
}

.sidebar-section h4 {
    margin: 0 0 10px;
    font-size: 14px;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 8px;
}

.schema-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#schema-input {
    width: 100%;
    height: 120px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: monospace;
    font-size: 13px;
    resize: none;
}

.url-import {
    display: flex;
    gap: 8px;
}

#json-url {
    flex: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.transform-actions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.history-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
}

.history-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
    border-radius: 4px;
}

.history-item {
    padding: 8px 10px;
    font-size: 13px;
    border-bottom: 1px solid #f0f0f0;
}

.history-item:last-child {
    border-bottom: none;
}

.history-time {
    color: #7f8c8d;
    font-size: 12px;
}

/* Buttons */
.btn-primary {
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-secondary {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-secondary:hover {
    background: #e9ecef;
    border-color: #ccc;
}

.btn-outline {
    background: none;
    color: #3498db;
    border: 1px solid #3498db;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-outline:hover {
    background: #e3f2fd;
}

.btn-outline-danger {
    background: none;
    color: #e74c3c;
    border: 1px solid #e74c3c;
    border-radius: 4px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-outline-danger:hover {
    background: #fde8e6;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1001;
    align-items: center;
    justify-content: center;
}

.modal-dialog {
    background: white;
    border-radius: 8px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 15px;
    border-bottom: 1px solid #e1e4e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 20px;
    color: #7f8c8d;
    cursor: pointer;
}

.modal-body {
    padding: 15px;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}

.sample-categories {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.category {
    border-bottom: 1px solid #eee;
    padding-bottom: 15px;
}

.category:last-child {
    border-bottom: none;
}

.category h4 {
    margin: 0 0 10px;
    font-size: 15px;
    color: #555;
}

.sample-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
}

.sample-btn {
    background: #404143;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.sample-btn:hover {
    background: #e9ecef;
    border-color: #ccc;
}

.sample-btn i {
    color: #3498db;
}

/* Tooltip */
.tooltip {
    position: fixed;
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 13px;
    pointer-events: none;
    opacity: 0;
    transform: translate(-50%, 10px);
    transition: opacity 0.2s, transform 0.2s;
    z-index: 1002;
}

.tooltip.show {
    opacity: 1;
    transform: translate(-50%, 0);
}

.tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #333 transparent transparent transparent;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .workspace {
        flex-direction: column;
    }
    
    .processing-controls {
        width: 100%;
        padding: 10px 0;
        flex-direction: row;
        justify-content: center;
    }
    
    .controls-container {
        flex-direction: row;
    }
    
    #process-btn {
        width: 40px;
        height: 40px;
        font-size: 16px;
    }
}

@media (max-width: 768px) {
    .tool-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .quick-actions {
        width: 100%;
        justify-content: flex-end;
    }
    
    .sidebar {
        width: 100%;
        right: -100%;
    }
    
    .sidebar.active {
        right: 0;
    }
}

/* Status colors */
.status-success {
    color: #27ae60;
}

.status-error {
    color: #e74c3c;
}

.status-warning {
    color: #f39c12;
}

.status-info {
    color: #3498db;
}

/* JSONEditor custom styles */
.jsoneditor {
    border: 1px solid #e1e4e8 !important;
}

.jsoneditor-menu {
    background-color: #3498db !important;
    border-bottom: 1px solid #3498db !important;
}

.jsoneditor-poweredBy {
    display: none !important;
}
</style>
 <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="{% static 'js/script.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-7J9Cxokf3FdauCj7SK8P0i23JZmH9u7hU8s9/hzjVms44B1Bv64eELp6IqQXq+JN"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/9.1.9/jsoneditor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/json2csv/5.0.6/json2csv.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/x2js/1.2.0/xml2json.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>

<!-- Include required libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-json.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-tomorrow.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/x2js/3.4.0/x2js.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/json2csv/5.0.7/json2csv.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.11.0/ajv.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/json-editor.min.js"></script>
{% endblock %}